sql code
-- =======================================================
-- CAMPUS EXCHANGE (PROJECT COMPONENTS EDITION)
-- Author: Adarsh L (PES2UG23CS025) 

-- FINAL FULL VERSION (Fully Functional & Validated)
-- =======================================================

-- 1️⃣ CREATE + RESET DATABASE
DROP DATABASE IF EXISTS campus_exchange;
CREATE DATABASE campus_exchange;
USE campus_exchange;

-- Disable foreign key checks for safe recreation
SET FOREIGN_KEY_CHECKS = 0;
DROP TABLE IF EXISTS Feedback;
DROP TABLE IF EXISTS Transactions;
DROP TABLE IF EXISTS Components;
DROP TABLE IF EXISTS Projects;
DROP TABLE IF EXISTS Users;
SET FOREIGN_KEY_CHECKS = 1;

-- =======================================================
-- 2️⃣ TABLE CREATION
-- =======================================================

CREATE TABLE Users (
  UserId INT AUTO_INCREMENT PRIMARY KEY,
  FullName VARCHAR(100) NOT NULL,
  Email VARCHAR(150) NOT NULL UNIQUE,
  PasswordHash VARCHAR(255) NOT NULL,
  Department VARCHAR(100),
  Role ENUM('student','admin') DEFAULT 'student',
  CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE Projects (
  ProjectId INT AUTO_INCREMENT PRIMARY KEY,
  Title VARCHAR(150) NOT NULL,
  Description TEXT,
  UserId INT NOT NULL,
  FOREIGN KEY (UserId) REFERENCES Users(UserId) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE Components (
  ComponentId INT AUTO_INCREMENT PRIMARY KEY,
  Name VARCHAR(100) NOT NULL,
  Type VARCHAR(100),
  Price DECIMAL(10,2) NOT NULL,
  Status ENUM('Available','Sold') DEFAULT 'Available',
  ProjectId INT NOT NULL,
  FOREIGN KEY (ProjectId) REFERENCES Projects(ProjectId) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE Transactions (
  TransactionId INT AUTO_INCREMENT PRIMARY KEY,
  BuyerId INT NOT NULL,
  ComponentId INT NOT NULL,
  Amount DECIMAL(10,2) NOT NULL,
  PaymentMethod ENUM('Cash','UPI','Card','Other') DEFAULT 'UPI',
  Status ENUM('Completed','Failed','Refunded') DEFAULT 'Completed',
  TransactionDate DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (BuyerId) REFERENCES Users(UserId) ON DELETE CASCADE,
  FOREIGN KEY (ComponentId) REFERENCES Components(ComponentId) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE Feedback (
  FeedbackId INT AUTO_INCREMENT PRIMARY KEY,
  BuyerId INT NOT NULL,
  ComponentId INT NOT NULL,
  Rating TINYINT CHECK (Rating BETWEEN 1 AND 5),
  Comments TEXT,
  CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (BuyerId) REFERENCES Users(UserId) ON DELETE CASCADE,
  FOREIGN KEY (ComponentId) REFERENCES Components(ComponentId) ON DELETE CASCADE
) ENGINE=InnoDB;

-- =======================================================
-- 3️⃣ TRIGGERS
-- =======================================================
DELIMITER $$

-- Prevent duplicate purchase of sold components
CREATE TRIGGER trg_before_transaction_insert
BEFORE INSERT ON Transactions
FOR EACH ROW
BEGIN
  DECLARE comp_status VARCHAR(20);
  SELECT Status INTO comp_status FROM Components WHERE ComponentId = NEW.ComponentId FOR UPDATE;
  IF comp_status = 'Sold' THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Component already sold.';
  END IF;
END$$

-- Automatically mark component as Sold after purchase
CREATE TRIGGER trg_after_transaction_insert
AFTER INSERT ON Transactions
FOR EACH ROW
BEGIN
  UPDATE Components SET Status = 'Sold' WHERE ComponentId = NEW.ComponentId;
END$$

DELIMITER ;

-- =======================================================
-- 4️⃣ STORED PROCEDURES
-- =======================================================

-- ✅ Strict purchase validation (exact payment = component price)
 DROP PROCEDURE IF EXISTS PurchaseComponent;
DELIMITER $$

CREATE PROCEDURE PurchaseComponent(
  IN p_BuyerId INT,
  IN p_ComponentId INT,
  IN p_Amount DECIMAL(10,2),
  IN p_PaymentMethod VARCHAR(20)
)
BEGIN
  DECLARE current_status VARCHAR(20);
  DECLARE component_price DECIMAL(10,2);
  DECLARE msg VARCHAR(255);

  START TRANSACTION;
    SELECT Status, Price INTO current_status, component_price
    FROM Components 
    WHERE ComponentId = p_ComponentId 
    FOR UPDATE;

    IF component_price IS NULL THEN
      ROLLBACK;
      SET msg = 'Component not found.';
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    ELSEIF current_status = 'Sold' THEN
      ROLLBACK;
      SET msg = 'Component already sold.';
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    ELSEIF p_Amount < component_price THEN
      ROLLBACK;
      SET msg = CONCAT('Insufficient payment. Component costs Rs ', component_price);
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    ELSEIF p_Amount > component_price THEN
      ROLLBACK;
      SET msg = CONCAT('Overpayment detected. Component costs Rs ', component_price);
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = msg;
    ELSE
      -- ✅ Valid payment → proceed safely
      INSERT INTO Transactions (BuyerId, ComponentId, Amount, PaymentMethod)
      VALUES (p_BuyerId, p_ComponentId, p_Amount, p_PaymentMethod);

      UPDATE Components SET Status = 'Sold' WHERE ComponentId = p_ComponentId;
      COMMIT;
    END IF;
END$$

DELIMITER ;

-- ✅ Feedback procedure
DROP PROCEDURE IF EXISTS AddFeedback;
DELIMITER $$

CREATE PROCEDURE AddFeedback(
  IN p_BuyerId INT,
  IN p_ComponentId INT,
  IN p_Rating TINYINT,
  IN p_Comments TEXT
)
BEGIN
  INSERT INTO Feedback (BuyerId, ComponentId, Rating, Comments)
  VALUES (p_BuyerId, p_ComponentId, p_Rating, p_Comments);
END$$

DELIMITER ;

-- =======================================================
-- 5️⃣ SAMPLE DATA
-- =======================================================

INSERT INTO Users (FullName, Email, PasswordHash, Department)
VALUES
('Adarsh L', 'adarsh@campus.edu', '1234', 'CSE'),
('Amar Sagar', 'amar@campus.edu', 'abcd', 'ECE'),
('Priya R', 'priya@campus.edu', 'xyz', 'EEE'),
('John Doe', 'john@campus.edu', 'qwerty', 'MECH');

INSERT INTO Projects (Title, Description, UserId)
VALUES
('Line Follower Robot', 'IR sensor-based robot project', 1),
('Smart Irrigation System', 'Automatic irrigation using soil moisture sensors', 2);

INSERT INTO Components (Name, Type, Price, ProjectId)
VALUES
('Arduino UNO', 'Microcontroller', 450.00, 1),
('IR Sensor', 'Sensor', 120.00, 1),
('Relay Module', 'Actuator', 200.00, 2),
('Soil Moisture Sensor', 'Sensor', 180.00, 2);

-- Buyer (Priya - ID 3) purchases Arduino UNO (ID 1)
CALL PurchaseComponent(3, 1, 450.00, 'UPI');

-- Buyer leaves feedback
CALL AddFeedback(3, 1, 5, 'Perfect condition and smooth transaction!');

-- =======================================================
-- 6️⃣ VIEWS (Readable summaries for dashboard & admin)
-- =======================================================

CREATE OR REPLACE VIEW v_ComponentStatus AS
SELECT 
  c.ComponentId,
  c.Name AS ComponentName,
  c.Type,
  c.Price,
  c.Status,
  p.Title AS ProjectTitle,
  u.FullName AS SellerName,
  u.Department
FROM Components c
JOIN Projects p ON c.ProjectId = p.ProjectId
JOIN Users u ON p.UserId = u.UserId;

CREATE OR REPLACE VIEW v_TransactionsDetailed AS
SELECT 
  t.TransactionId,
  u.FullName AS BuyerName,
  c.Name AS ComponentName,
  c.Status AS ComponentStatus,
  t.Amount,
  t.PaymentMethod,
  t.Status AS TransactionStatus,
  t.TransactionDate
FROM Transactions t
JOIN Users u ON t.BuyerId = u.UserId
JOIN Components c ON t.ComponentId = c.ComponentId;

CREATE OR REPLACE VIEW v_FeedbackDetailed AS
SELECT 
  f.FeedbackId,
  b.FullName AS BuyerName,
  c.Name AS ComponentName,
  f.Rating,
  f.Comments,
  f.CreatedAt
FROM Feedback f
JOIN Users b ON f.BuyerId = b.UserId
JOIN Components c ON f.ComponentId = c.ComponentId;

-- =======================================================
-- 7️⃣ VERIFICATION (Run to confirm everything works)
-- =======================================================

SELECT '✅ Campus Exchange setup successful!' AS Status;

SHOW TABLES;
USE campus_exchange;

 
 SELECT * FROM Transactions;
SELECT * FROM Feedback;
SELECT * FROM v_ComponentStatus;
SELECT * FROM v_TransactionsDetailed;
SELECT * FROM v_FeedbackDetailed;

